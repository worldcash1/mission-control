---
tags:
  - trading
  - projects/earnings-tracker
  - automation
---

# 2026-02-08 ‚Äî OQuants Snapshot System Built

## OQuants Pre-Earnings Snapshot System (Phase 1 Complete)

### CLIs Built
- `~/bin/oquants-snapshot` ‚Äî Daily pre-earnings data capture, 18 API endpoints per ticker
- `~/bin/oquants-parse-summary` ‚Äî Parses raw JSON into structured summary.json

### Key Findings
- **Two different backtests on OQuants:**
  - `/volatility/backtest` = rolling 30d short straddle (VRP strategy) ‚Äî NOT earnings-specific
  - `/earnings/returns` = straddle returns ONLY through earnings events ‚Äî THIS is the real earnings backtest
  - CLF example: vol backtest showed 48.3% WR (misleading), earnings backtest showed 69% seller WR (correct)
- **2 directional endpoints don't work via API:** price-distribution and skew-signal return null for all tickers (server-rendered only). Momentum and PEAD work fine.
- Session cookie auto-refresh on expiry works
- ~72 seconds per ticker with conservative pacing (18 calls √ó 2s + overhead)

### Cron Setup
- **OQuants Pre-Earnings Snapshot** ‚Äî 3:00 PM ET (20:00 UTC) Mon-Fri
  - Job ID: `ec5c9bc5-aafb-4fe0-a350-5fbadef5d316`
  - Model: Sonnet
  - Auto-pulls calendar, snapshots all tickers reporting next day
  - Posts summary to #üí∞-earnings-tracker

### Data Storage
- `~/data/oquants/snapshots/YYYY-MM-DD/TICKER/` ‚Äî raw JSON + summary.json per ticker
- `~/data/oquants/snapshots/YYYY-MM-DD/run_metadata.json` ‚Äî run stats
- First real run tomorrow: 47 tickers

### Still To Build
- Trade Tracker MVP app (Next.js + Convex)

## schwab-trades Reconstructor ‚Äî Major Fixes (Late Session)

### Key Discovery: `positionEffect` field
- Schwab API has `positionEffect: "OPENING" | "CLOSING"` on each transferItem
- This is the definitive way to tell if a leg was opening or closing a position
- Previously relied on heuristics (first trade = open, opposite direction = close) ‚Äî broke when Nam legs into ICs piece by piece

### How Nam Trades ICs
- Often sells the straddle first, then buys wings individually as separate orders
- All legs end up as the same IC structure, just entered in multiple transactions
- Contract sizes match across legs
- Structure is almost always iron condor/butterfly (same thing, just naming)

### Fixes Applied to `~/bin/schwab-trades`
1. **positionEffect tracking** ‚Äî New actions: OPEN_BUY, OPEN_SELL, CLOSE_BUY, CLOSE_SELL (falls back to old heuristic if field missing)
2. **Structure detection from all legs** ‚Äî Expired wings (RECEIVE_AND_DELIVER) now count for structure identification. Previously only opening legs were checked, missing wings that expired outside the API window
3. **Ghost trade filtering** ‚Äî Trades with 0 contracts (only expirations visible, no opens) are filtered out
4. **tradeDate fix** ‚Äî API uses `tradeDate` field (not `transactionDate`) for TRADE type; added `time` as fallback
5. **Strategy auto-tagging** ‚Äî EARNINGS_VOL_SELL, DIRECTIONAL, PREMIUM_SELL, VRP, VERTICAL based on structure + hold duration
6. **Strategy breakdown in summary** ‚Äî Shows W/L and P&L per strategy type

### Results (21-day window, 54 trades)
- üìä Earnings Vol-Sell: **17W/10L = 63% WR** | -$4.09 net (basically breakeven)
- üí∞ Premium Sell: 7W/2L (78%) | +$372
- üéØ Directional: 1W/1L | -$746 (mostly IREN)
- Overall: 26W/16L (62%) | +$356 net

### AMD Example (the debugging case)
- TOS showed: IC opened as single order (SELL 7x 245C, SELL 7x 245P, BUY 7x 285C, BUY 7x 200P) at $19.25 credit
- Schwab API returned same legs but needed positionEffect to distinguish opens from closes
- Now correctly shows: IRON_BUTTERFLY, $134.75 credit, -$97.79 P&L

### Remaining Issues
- Some "Other" trades (LPTH, VOD, NVDA) are just long calls ‚Äî correctly tagged as ‚ùì since they don't fit a known strategy bucket
- IREN 1010x long calls showing as directional ‚Äî this was the coiled play, correct to exclude from earnings
