---
tags:
  - projects/marriott-scanner
  - automation
  - maintenance
---

# 2026-02-06 Daily Log

## Marriott Scanner - Anti-Bot Browser Work

### Session Summary
Worked extensively on making Marriott MMP scanner bypass Akamai bot detection. Multiple approaches tested.

### Methods Tested

| Method | Result | Notes |
|--------|--------|-------|
| Clawd browser (Playwright) | ‚ùå Blocked | Works initially, blocked after ~10-15 requests |
| Stealth plugin (puppeteer-extra) | ‚ùå Blocked | Stealth alone not enough for Akamai |
| Bright Data Browser API | ‚ö†Ô∏è Timeout | Remote browser slow, 60s timeout |
| Bright Data Residential Proxy | ‚ö†Ô∏è Partial | Connects but JS doesn't render properly |
| Chrome Relay (Nam's browser) | ‚úÖ Works | Most reliable - uses real browser session |

### Bright Data Setup
- Logged into Nam's Bright Data account (namhbca@yahoo.com)
- Created residential proxy zone: `residential_proxy1`
- Credentials saved to `~/clawd/secrets/brightdata.env`
- Account balance: $24.69
- Residential proxy: $8.40/GB

### Bright Data Credentials
```
# Residential Proxy
Host: brd.superproxy.io
Port: 33335
User: brd-customer-hl_e5961586-zone-residential_proxy1
Pass: in302ju7djde

# Browser API (existing)
Zone: mcp_browser
WS: wss://brd-customer-hl_e5961586-zone-mcp_browser:jkq4d32treh0@brd.superproxy.io:9222
```

### Stealth Browser Project Created
- Location: `~/projects/stealth-browser/`
- Scripts: `marriott.js`, `marriott-brightdata.js`, `marriott-proxy.js`
- Uses puppeteer-extra with stealth plugin
- Needs residential proxy or Browser API to work reliably

### Key Learnings
1. Marriott uses Akamai Enterprise bot detection
2. Stealth plugins alone not sufficient
3. Residential proxy connects but doesn't render JS
4. Browser API works but slow (remote browser in different region)
5. **Best solution**: Web Unlocker API ($1.50/1k) or Chrome Relay

### Location Note
- Nam is in Dubai
- Mac Mini is in Hong Kong (not California as I assumed earlier)

### Next Steps for Marriott Scanner
1. Try Web Unlocker API (handles JS rendering automatically)
2. Or verify KYC for full residential access
3. Or use Chrome Relay when prices needed (works reliably)
4. Consider mobile API reverse engineering when Nam back on same network

### PDF Generated
- Created Dubai MMP calendar PDF for February 2026
- 12 hotels scanned before IP got blocked
- Best deals: Aloft Creek AED 209, Palm Jumeirah AED 382
- File: `~/projects/marriott-scanner/scripts/dubai-mmp-feb-2026.pdf`

### AGENTS.md Updated
- Added rule: "Close browsers when done" to avoid slowing computer

---

## üéâ MMP Scraper Breakthrough (11 PM Session)

### HAR File Analysis
- Nam captured HAR file from Marriott on his MacBook
- Discovered GraphQL API endpoint: `/mi/query/phoenixShopADFSearchProductsByProperty`
- Key finding: `rateRequestTypes: [{value: "MMP", type: "CLUSTER"}]` triggers MMP rates
- Direct API calls blocked by Akamai

### Solution Built: Browser Session + CDP
**Working approach:**
1. Launch Brave with `--remote-debugging-port=9222`
2. Navigate to Marriott rate calendar manually
3. Run `node mmp.js` to scrape rates from DOM
4. Uses Chrome DevTools Protocol to connect to real browser

**Files created in `~/projects/marriott-mmp/`:**
- `mmp.js` - Main scraper (connects to running Brave)
- `mmp-login.js` - Opens browser for session setup (Playwright)
- `mmp-login-stealth.js` - Stealth version with puppeteer-extra
- `mmp-rates-stealth.js` - Headless rate fetcher (blocked by Akamai)
- `mmp-connect.js` - CDP connector script
- `mmp-bot.js` - Server-side scraper attempt

**Results from Nam's MacBook:**
```
üè® HKGDT - February 2026
2026-02-12   $931 üî• DEAL!
2026-02-15   $931 üî• DEAL!
2026-02-23   $931 üî• DEAL!
...
üìä Best: $931 on 2026-02-12 üî•
üìä High: $3,904 on 2026-02-10
```

### Mac Mini Server Attempt
- Brave runs in headed mode (not headless) on Mac Mini
- Connects successfully, passes Akamai bot detection
- **BUT** MMP rates don't load ‚Äî session not authenticated
- Need: Login to Marriott Bonvoy OR transfer session from Nam's MacBook

### Next Steps
1. Set up Discord `!mmp` command handler
2. Either:
   - Nam logs into Marriott on Mac Mini browser (via screen share)
   - Transfer session cookies from MacBook to Mac Mini
   - Use MacBook as scraping server when online

### Key Lesson
Akamai blocks:
- Headless browsers ‚ùå
- Puppeteer/Playwright default ‚ùå
- Direct API calls ‚ùå
- Fresh browser sessions without warmup ‚ùå

Akamai allows:
- Real browser with remote debugging ‚úÖ
- Puppeteer connecting to existing browser session ‚úÖ
- Headed mode (even on headless Mac) ‚úÖ
- Browser with established cookies/session ‚úÖ

### Discord Bot Commands Built
- `!mmp scan <city>` ‚Äî Scan all hotels in a city, show best deals
- `!mmp search <city>` ‚Äî List hotel codes for a city
- `!mmp <CODE>` ‚Äî Get full rate calendar for specific hotel

**Files in `~/projects/marriott-mmp/`:**
- `discord-mmp.js` ‚Äî Main Discord bot handler
- `scan-city.js` ‚Äî City scanner with price comparison
- `search-hotels.js` ‚Äî Hotel code lookup
- `get-rates.js` ‚Äî Single hotel rate calendar

### Outstanding Issues
1. Date range support (`feb-apr`) ‚Äî month navigation causes browser instability
2. Browser session persistence ‚Äî fresh browsers get blocked by Akamai
3. Need "warm" browser with established cookies for reliable scraping

### Best Deals Found Tonight
- **Tokyo:** Four Points Shibuya ¬•5,790 (~$39/night) üî•
- **Hong Kong:** JW Marriott $931 HKD (~$120/night) üî•

---

## MMP Scanner PDF Design Audit (Late Night ‚Üí Feb 7 1am)

### Dark Theme Improvements (3 Phases)
**Phase 1:**
- Best Deals reduced from 6 to 3 chips
- Matrix cells larger with more padding
- Hotel names shortened intelligently (removed "Sheraton", "Marriott" prefixes)
- Best Deals section got premium green gradient styling

**Phase 2:**
- Simplified color palette: 3 colors only (cyan=best, green=deal, neutral=available)
- Removed emojis from section headers
- Larger calendar cells
- Simplified legend (4 items instead of 5)

**Phase 3:**
- Subtle footer (barely visible, doesn't compete)
- Tier labels uppercase with refined typography
- Hotel cards with subtle shadows
- Row guides for easier scanning

### Light Theme Created
- Created `generate-pdf-light.js` with inverted theme
- **Nam prefers light version** ‚òÄÔ∏è

### Light Theme Design Audit (Additional 3 Phases)
**Phase 1:**
- Best Deals: white card with green accents (better contrast)
- "Best Price" cells: cyan gradient + border (really pops!)
- Unavailable dates: darker gray (more visible)

**Phase 2:**
- Hotel cards: stronger shadows for separation
- Tier labels: softer colors (not harsh on light bg)

**Phase 3:**
- Alternating row backgrounds in summary matrix
- Lighter section dividers (1px instead of 2px)

### Files Modified
- `~/projects/marriott-mmp/generate-pdf.js` - dark theme improvements
- `~/projects/marriott-mmp/generate-pdf-light.js` - NEW light theme

### Status
Both themes polished and ready. Awaiting Nam's go-ahead on full Tokyo scan.
